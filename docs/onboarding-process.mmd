%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#e3f2fd', 'primaryTextColor': '#01579b'}}}%%
flowchart TB
    subgraph Entry["Entry Point"]
        A[("initialize-onboarding<br/>Initialize Onboarding")]
    end

    subgraph Validation["Initial Validation"]
        B["validate-candidate<br/>Validate Candidate"]
    end

    subgraph BackgroundCheck["Background Check"]
        C["run-background-check<br/>Run Background Check"]
        C2["ai-analyze-background-check<br/>AI Analyze Background<br/>(AGENT_ASSISTED)"]
        D["review-background-results<br/>Review Background Results<br/>(HUMAN_TASK)"]
    end

    subgraph Parallel["Parallel Execution (after BG check passes)"]
        direction TB
        subgraph IT["IT Provisioning"]
            E["order-equipment<br/>Order Equipment"]
            F["ship-equipment<br/>Ship Equipment"]
            G["create-accounts<br/>Create Accounts"]
        end

        subgraph HR["HR Documentation"]
            H["collect-documents<br/>Collect Documents<br/>(HUMAN_TASK)"]
            I["verify-i9<br/>Verify I-9<br/>(HUMAN_TASK)"]
        end
    end

    subgraph Completion["Completion"]
        J["schedule-orientation<br/>Schedule Orientation"]
        K(["finalize-onboarding<br/>Finalize Onboarding"])
    end

    subgraph Cancellation["Cancellation Path"]
        L(["cancel-onboarding<br/>Cancel Onboarding"])
    end

    %% Main flow - Entry to Validation
    A -->|"offer.status = ACCEPTED"| B

    %% Validation to Background Check
    B -->|"validation.status = PASSED"| C
    B -.->|"validation failed"| L

    %% Background Check to AI Analysis
    C -->|"bgCheck.status = COMPLETED"| C2
    C -.->|"bgCheck failed"| L

    %% AI Analysis paths
    C2 -->|"aiAnalysis.requiresReview = true"| D
    C2 -->|"aiAnalysis.passed = true<br/>(parallel)"| E
    C2 -->|"aiAnalysis.passed = true<br/>(parallel)"| G
    C2 -->|"aiAnalysis.passed = true<br/>(parallel)"| H

    %% Review paths
    D -->|"review approved<br/>(parallel)"| E
    D -->|"review approved<br/>(parallel)"| G
    D -->|"review approved<br/>(parallel)"| H
    D -.->|"review rejected"| L

    %% IT Provisioning flow
    E -->|"equipmentOrder.status = READY"| F
    G --> J
    F --> J

    %% HR Documentation flow
    H -->|"documents collected<br/>US employee"| I
    I --> J

    %% Completion
    J -->|"all prerequisites met"| K

    %% Policy Gates shown
    C -.->|"Policy: FCRA Compliance<br/>Policy: Ban-the-Box"| C
    G -.->|"Policy: Access Policy"| G
    H -.->|"Policy: Document Compliance"| H
    I -.->|"Policy: I-9 Compliance"| I

    %% Styling
    classDef entry fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    classDef process fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef humanTask fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef complete fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px
    classDef cancel fill:#ffcdd2,stroke:#c62828,stroke-width:2px
    classDef bgcheck fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef aiAgent fill:#e8f5e9,stroke:#388e3c,stroke-width:2px

    class A entry
    class B,E,F,G,J process
    class C,D bgcheck
    class C2 aiAgent
    class H,I humanTask
    class K complete
    class L cancel
